define("orbit_common",["orbit_common/lib/exceptions","orbit_common/main","orbit_common/cache","orbit_common/id_map","orbit_common/schema","orbit_common/source","orbit_common/memory_source"],function(a,b,c,d,e,f,g){"use strict";var h=a.OperationNotAllowed,i=a.RecordNotFoundException,j=a.LinkNotFoundException,k=a.RecordAlreadyExistsException;return b.Cache=c,b.Schema=e,b.Source=f,b.MemorySource=g,b.OperationNotAllowed=h,b.RecordNotFoundException=i,b.LinkNotFoundException=j,b.RecordAlreadyExistsException=k,b}),define("orbit_common/cache",["orbit/lib/objects","orbit_common/lib/exceptions","orbit/document","orbit/evented"],function(a,b,c,d){"use strict";var e=(a.expose,a.isArray),f=b.OperationNotAllowed,g=function(){this.init.apply(this,arguments)};return g.prototype={constructor:g,init:function(a,b){b=b||{},this.trackChanges=void 0!==b.trackChanges?b.trackChanges:!0,this.trackRevLinks=void 0!==b.trackRevLinks?b.trackRevLinks:!0,this.trackRevLinkChanges=void 0!==b.trackRevLinkChanges?b.trackRevLinkChanges:!1,this._doc=new c(null,{arrayBasedPaths:!0}),d.extend(this),this.schema=a;for(var e in a.models)a.models.hasOwnProperty(e)&&this._registerModel(e);this.schema.on("modelRegistered",this._registerModel,this)},_registerModel:function(a){var b=[a];this.retrieve(b)||this._doc.add(b,{})},reset:function(a){this._doc.reset(a),this.schema.registerAllIds(a)},length:function(a){var b=this.retrieve(a);return null===b?null:e(b)?b.length:Object.keys(b).length},retrieve:function(a){try{return this._doc.retrieve(a)}catch(b){return null}},transform:function(a){var b=a.op,c=a.path;if(c=this._doc.deserializePath(c),"add"!==b&&"remove"!==b&&"replace"!==b)throw new f('Cache#transform requires an "add", "remove" or "replace" operation.');if(c.length<2)throw new f("Cache#transform requires an operation with a path >= 2 segments.");!this.trackRevLinks||"remove"!==b&&"replace"!==b||this._removeRevLinks(c),this._transform(a,this.trackChanges),!this.trackRevLinks||"add"!==b&&"replace"!==b||this._addRevLinks(c,a.value)},_transform:function(a,b){if(b){var c=this._doc.transform(a,!0);this.emit("didTransform",a,c)}else this._doc.transform(a,!1)},_addRevLinks:function(a,b){if(b){var c,d,e=this,f=a[0],g=a[1];if(2===a.length)b.__rel&&Object.keys(b.__rel).forEach(function(a){c=e.schema.models[f].links[a],d=b.__rel[a],"hasMany"===c.type?Object.keys(d).forEach(function(b){e._addRevLink(c,f,g,a,b)}):e._addRevLink(c,f,g,a,d)});else if(a.length>3){var h=a[3];c=e.schema.models[f].links[h],d=5===a.length?a[4]:b,this._addRevLink(c,f,g,h,d)}}},_addRevLink:function(a,b,c,d,e){if(e&&"string"==typeof e){var f=[b,c,"__rel",d];"hasMany"===a.type&&f.push(e),f="/"+f.join("/");var g=[a.model,e,"__rev"],h=this.retrieve(g);h?(g.push(f),h=this.retrieve(g),h||this._transformRef("add",g,!0)):(h={},h[f]=!0,this._transformRef("add",g,h))}},_removeRevLinks:function(a){var b=this.retrieve(a);if(b){var c,d,e=this,f=a[0],g=a[1];if(2===a.length){if(b.__rev){var h;Object.keys(b.__rev).forEach(function(a){a=e._doc.deserializePath(a),h=4===a.length?{op:"replace",path:a,value:null}:{op:"remove",path:a};try{e._transform(h,e.trackChanges)}catch(b){console.log("Cache._transform() exception:",b,"operation:",h)}})}b.__rel&&Object.keys(b.__rel).forEach(function(a){c=e.schema.models[f].links[a],d=b.__rel[a],"hasMany"===c.type?Object.keys(d).forEach(function(b){e._removeRevLink(c,f,g,a,b)}):e._removeRevLink(c,f,g,a,d)})}else if(a.length>3){var i=a[3];c=e.schema.models[f].links[i],d=5===a.length?a[4]:b,this._removeRevLink(c,f,g,i,d)}}},_removeRevLink:function(a,b,c,d,e){if(e&&"string"==typeof e){var f=[b,c,"__rel",d];"hasMany"===a.type&&f.push(e),f="/"+f.join("/");var g=[a.model,e,"__rev",f];this._transformRef("remove",g)}},_transformRef:function(a,b,c){var d={op:a,path:b};c&&(d.value=c);try{this._transform(d,this.trackRevLinkChanges)}catch(e){console.log("Cache._transformRef() exception",e,"for operation",d)}}},g}),define("orbit_common/id_map",["orbit/lib/assert"],function(a){"use strict";var b=a.assert,c=function(){this.init.apply(this,arguments)};return c.prototype={constructor:c,init:function(a,c){b("IdMap's `idField` must be specified",a),b("IdMap's `remoteIdField` must be specified",c),this.idField=a,this.remoteIdField=c,this.reset()},reset:function(){this._remoteToLocal={},this._localToRemote={}},register:function(a,b,c){if(b&&c){var d=this._remoteToLocal[a];d||(d=this._remoteToLocal[a]={}),d[c]=b;var e=this._localToRemote[a];e||(e=this._localToRemote[a]={}),e[b]=c}},registerAll:function(a){if(a){var b,c,d,e=this;Object.keys(a).forEach(function(f){b=e._remoteToLocal[f],b||(b=e._remoteToLocal[f]={}),c=e._localToRemote[f],c||(c=e._localToRemote[f]={});var g=a[f];Object.keys(g).forEach(function(a){d=g[a][e.remoteIdField],d&&(b[d]=a,c[a]=d)})})}},remoteToLocalId:function(a,b){if(b){var c=this._remoteToLocal[a];if(c)return c[b]}},localToRemoteId:function(a,b){if(b){var c=this._localToRemote[a];if(c)return c[b]}}},c}),define("orbit_common/lib/exceptions",["exports"],function(a){"use strict";var b=function(a){this.description=a};b.prototype={constructor:b};var c=function(a,b){this.type=a,this.record=b};c.prototype={constructor:c};var d=function(a,b,c){this.type=a,this.record=b,this.key=c};d.prototype={constructor:d};var e=function(a,b){this.type=a,this.record=b};e.prototype={constructor:e},a.OperationNotAllowed=b,a.RecordNotFoundException=c,a.LinkNotFoundException=d,a.RecordAlreadyExistsException=e}),define("orbit_common/main",[],function(){"use strict";var a={};return a}),define("orbit_common/memory_source",["orbit/lib/assert","orbit/lib/objects","orbit_common/lib/exceptions","orbit/main","orbit_common/source"],function(a,b,c,d,e){"use strict";var f=a.assert,g=b.extend,h=b.isArray,i=b.isNone,j=c.RecordNotFoundException,k=c.LinkNotFoundException,l=function(){this.init.apply(this,arguments)};return g(l.prototype,e.prototype,{constructor:l,init:function(){f("MemorySource requires Orbit.Promise to be defined",d.Promise),e.prototype.init.apply(this,arguments)},_transform:function(a){this._cache.transform(a)},_find:function(a,b){var c,e=this,f=this.schema.idField,g=this.schema.remoteIdField;return new d.Promise(function(d,k){if(i(b))c=e._filter.call(e,a);else if(h(b)){var l,m,n;c=[],n=[];for(var o=0,p=b.length;p>o;o++)m=b[o],l="object"==typeof m&&m[g]?e._filterOne.call(e,a,g,m[g]):e.retrieve([a,m]),l?c.push(l):n.push(m);n.length>0&&(c=null,b=n)}else c="object"==typeof b?b[f]?e.retrieve([a,b[f]]):b[g]?e._filterOne.call(e,a,g,b[g]):e._filter.call(e,a,b):e.retrieve([a,b]);c?d(c):k(new j(a,b))})},_findLink:function(a,b,c){var e,f=this,g=this.schema.idField;return new d.Promise(function(d,h){if(e=f.retrieve("object"==typeof b?[a,b[g]]:[a,b])){var i;if(e.__rel&&(i=e.__rel[c])){var l=f.schema.models[a].links[c],m=l.model;if("hasMany"===l.type){var n,o,p=Object.keys(i);i=[],o=[],p.forEach(function(a){n=f.retrieve([m,a]),n?i.push(n):o.push(n)}),o.length>0&&(i=null)}else i=f.retrieve([m,i])}i?d(i):h(new k(a,b,c))}else h(new j(a,b))})},_filter:function(a,b){var c,d,e,f,g,h=[];c=this.retrieve([a]);for(d in c)if(c.hasOwnProperty(d)){if(g=c[d],void 0===b)f=!0;else{f=!1;for(e in b){if(g[e]!==b[e]){f=!1;break}f=!0}}f&&h.push(g)}return h},_filterOne:function(a,b,c){var d,e,f;d=this.retrieve([a]);for(e in d)if(d.hasOwnProperty(e)&&(f=d[e],f[b]===c))return f}}),l}),define("orbit_common/schema",["orbit/lib/objects","orbit_common/lib/exceptions","orbit/evented","orbit_common/id_map"],function(a,b,c,d){"use strict";var e=(a.clone,b.OperationNotAllowed),f=function(){this.init.apply(this,arguments)};return f.prototype={constructor:f,init:function(a){a=a||{},this.idField=void 0!==a.idField?a.idField:"__id",this.remoteIdField=void 0!==a.remoteIdField?a.remoteIdField:"id",this.models=void 0!==a.models?a.models:{},a.generateId&&(this.generateId=a.generateId),this.idField!==this.remoteIdField&&(this._idMap=new d(this.idField,this.remoteIdField)),c.extend(this)},registerModel:function(a,b){this.models[a]=b,this.emit("modelRegistered",a)},normalize:function(a,b){if(b.__normalized)return b;var c=b;if(c.__normalized=!0,this._idMap){var d=c[this.idField],e=c[this.remoteIdField];void 0===d&&(e&&(d=this._idMap.remoteToLocalId(a,e)),d=d||this.generateId(),c[this.idField]=d),this._idMap.register(a,d,e)}else c[this.idField]=c[this.idField]||this.generateId();return c.__rev=c.__rev||{},c.__rel=c.__rel||{},this.initDefaults(a,c),c},initDefaults:function(a,b){if(!b.__normalized)throw new e("Schema.initDefaults requires a normalized record");var c=this.models[a],d=c.attributes,f=c.links;if(d)for(var g in d)void 0===b[g]&&(b[g]=d[g].defaultValue?"function"==typeof d[g].defaultValue?d[g].defaultValue.call(b):d[g].defaultValue:null);if(f)for(var h in f)void 0===b.__rel[h]&&(b.__rel[h]="hasMany"===f[h].type?{}:null)},generateId:function(){return void 0===this._newId&&(this._newId=0),(new Date).getTime()+"."+(this._newId++).toString()},remoteToLocalId:function(a,b){return this._idMap?this._idMap.remoteToLocalId(a,b):b},localToRemoteId:function(a,b){return this._idMap?this._idMap.localToRemoteId(a,b):b},registerIds:function(a,b){this._idMap&&this._idMap.register(a,b[this.idField],b[this.remoteIdField])},registerAllIds:function(a){this._idMap&&a&&this._idMap.registerAll(a)},pluralize:function(a){return a+"s"}},f}),define("orbit_common/source",["orbit/lib/assert","orbit/lib/stubs","orbit/lib/objects","orbit/document","orbit/transformable","orbit/requestable","orbit_common/cache"],function(a,b,c,d,e,f,g){"use strict";var h=a.assert,i=b.required,j=c.expose,k=function(){this.init.apply(this,arguments)};return k.prototype={constructor:k,init:function(a,b){h("Source's `schema` must be specified",a),h("Source's `schema.idField` must be specified",a.idField),this.schema=a,b=b||{},this._cache=new g(a),j(this,this._cache,"length","reset","retrieve"),this._cache.on("didTransform",this._cacheDidTransform,this),e.extend(this),f.extend(this,["find","add","update","patch","remove","findLink","addLink","removeLink"])},_transform:i,_find:i,_findLink:i,_add:function(a,b){var c=this.normalize(a,b),d=this.getId(c),e=[a,d],f=this;return this.transform({op:"add",path:e,value:c}).then(function(){return f.retrieve(e)})},_update:function(a,b){var c=this.normalize(a,b),d=this.getId(c),e=[a,d],f=this;return this.transform({op:"replace",path:e,value:c}).then(function(){return f.retrieve(e)})},_patch:function(a,b,c,e){if("object"==typeof b){var f=this.normalize(a,b);b=this.getId(f)}return this.transform({op:"replace",path:[a,b].concat(d.prototype.deserializePath(c)),value:e})},_remove:function(a,b){if("object"==typeof b){var c=this.normalize(a,b);b=this.getId(c)}return this.transform({op:"remove",path:[a,b]})},_addLink:function(a,b,c,d){var e,f=function(a,b,c,d,e){var f=[b,c,"__rel",d];return"hasMany"===a.type&&(f.push(e),e=!0),{op:"add",path:f,value:e}},g=this.schema.models[a].links[c],h=this;if("object"==typeof b){var i=this.normalize(a,b);b=this.getId(i)}if("object"==typeof d){var j=this.normalize(g.model,d);d=this.getId(j)}if(e=[f(g,a,b,c,d)],g.inverse){var k=this.schema.models[g.model].links[g.inverse];e.push(f(k,g.model,d,g.inverse,b))}return this.transform(e).then(function(){return h.retrieve([a,b])})},_removeLink:function(a,b,c,d){var e,f,g=function(a,b,c,d,e){var f=[b,c,"__rel",d];return"hasMany"===a.type&&f.push(e),{op:"remove",path:f}},h=this.schema.models[a].links[c],i=this;if("object"==typeof b&&(f=this.normalize(a,b),b=this.getId(f)),"object"==typeof d){var j=this.normalize(h.model,d);d=this.getId(j)}if(e=[g(h,a,b,c,d)],h.inverse){void 0===d&&(void 0===f&&(f=this.retrieve(a,b)),d=f.__rel[c]);var k=this.schema.models[h.model].links[h.inverse];e.push(g(k,h.model,d,h.inverse,b))}return this.transform(e).then(function(){return i.retrieve([a,b])})},_cacheDidTransform:function(a,b){this.didTransform(a,b)},normalize:function(a,b){return this.schema.normalize(a,b)},initDefaults:function(a,b){return this.schema.initDefaults(a,b)},getId:function(a){return a[this.schema.idField]}},k});