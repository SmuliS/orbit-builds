define("orbit_common/jsonapi_source",["orbit/lib/assert","orbit/lib/objects","orbit_common/lib/exceptions","orbit/main","orbit_common/source"],function(a,b,c,d,e){"use strict";var f=a.assert,g=b.clone,h=b.extend,i=c.RecordNotFoundException,j=c.RecordAlreadyExistsException,k=function(){this.init.apply(this,arguments)};return h(k.prototype,e.prototype,{constructor:k,init:function(a,b){f("JSONAPISource requires Orbit.Promise be defined",d.Promise),f("JSONAPISource requires Orbit.ajax be defined",d.ajax),e.prototype.init.apply(this,arguments),b=b||{},this.schema=a,this.remoteIdField=b.remoteIdField||"id",this.namespace=b.namespace,this.headers=b.headers,this._remoteToLocalIdMap={},this._localToRemoteIdMap={}},initRecord:function(a,b){var c=b[this.schema.idField],d=b[this.remoteIdField];d&&!c&&(c=b[this.idField]=this._remoteToLocalId(d)),c||(this.schema.initRecord(a,b),c=b[this.schema.idField]),this._updateRemoteIdMap(a,c,d)},_transform:function(a){var b,c,d=this,e=a.path,f=a.value,g=e[0],h=e[1];if(e.length>2){if(b=this._localToRemoteId(g,h),!b)throw new i(g,h);var k=this._buildURL(g,b);if(e=e.slice(2),"links"===e[0]){var l,m=e[1],n=this._cache.schema.models[g].links[m];"remove"===a.op?e.length>2&&(l=e.pop(),e.push(this._localToRemoteId(n.model,l))):(e.length>2?(l=e.pop(),e.push("-")):l=f,f=this._localToRemoteId(n.model,l))}var o={op:a.op,path:k+"/"+e.join("/")};return f&&(o.value=f),this._ajax(k,"PATCH",{data:o}).then(function(){d._transformCache(a)})}if("add"===a.op){if(h){var p=d.retrieve([g,h]);if(p)throw new j(g,h)}return this._ajax(this._buildURL(g),"POST",{data:this._serialize(g,f)}).then(function(a){c=d._deserialize(g,a),c[d.schema.idField]=h,d._addToCache(g,c)})}if(b=this._localToRemoteId(g,h),!b)throw new i(g,h);return"replace"===a.op?this._ajax(this._buildURL(g,b),"PUT",{data:this._serialize(g,f)}).then(function(a){c=d._deserialize(g,a),c[d.schema.idField]=h,d._addToCache(g,c)}):"remove"===a.op?this._ajax(this._buildURL(g,b),"DELETE").then(function(){d._transformCache(a)}):void 0},_find:function(a,b){if(!b||"number"!=typeof b&&"string"!=typeof b)return b&&"object"==typeof b&&b[this.remoteIdField]?this._findOne(a,b[this.remoteIdField]):this._findQuery(a,b);var c=this._localToRemoteId(a,b);if(!c)throw new i(a,b);return this._findOne(a,c)},_addToCache:function(a,b){this.initRecord(a,b),this._transformCache({op:"add",path:[a,b[this.schema.idField]],value:b})},_findOne:function(a,b){var c=this;return this._ajax(this._buildURL(a,b),"GET").then(function(b){var d=c._deserialize(a,b);return c._addToCache(a,d),c.settleTransforms().then(function(){return d})})},_findQuery:function(a,b){var c=this;return this._ajax(this._buildURL(a),"GET",{data:b}).then(function(b){var d,e=[];return b.forEach(function(b){d=c._deserialize(a,b),c._addToCache(a,d),e.push(d)}),c.settleTransforms().then(function(){return e})})},_localToRemoteId:function(a,b){var c=this._localToRemoteIdMap[a];return c?c[b]:void 0},_remoteToLocalId:function(a,b){var c=this._remoteToLocalIdMap[a];return c?c[b]:void 0},_transformCache:function(a){var b,c;b="add"===a.op?a.path.slice(0,a.path.length-1):a.path,c=this.retrieve(b)?this._cache.transform(a,!0):[],this.didTransform(a,c)},_updateRemoteIdMap:function(a,b,c){if(b&&c){var d;d=this._remoteToLocalIdMap[a],d||(d=this._remoteToLocalIdMap[a]={}),d[c]=b,d=this._localToRemoteIdMap[a],d||(d=this._localToRemoteIdMap[a]={}),d[b]=c}},_ajax:function(a,b,c){var e=this;return new d.Promise(function(f,g){if(c=c||{},c.url=a,c.type=b,c.dataType="json",c.context=e,c.data&&"GET"!==b&&(c.contentType="application/json; charset=utf-8",c.data=JSON.stringify(c.data)),void 0!==e.headers){var h=e.headers;c.beforeSend=function(a){for(var b in h)h.hasOwnProperty(b)&&a.setRequestHeader(b,h[b])}}c.success=function(a){f(a)},c.error=function(a){a&&(a.then=null),g(a)},d.ajax(c)})},_buildURL:function(a,b){var c=this.host,d=this.namespace,e=[];return c&&e.push(c),d&&e.push(d),e.push(this._pathForType(a)),b&&e.push(b),e=e.join("/"),c||(e="/"+e),e},_pathForType:function(a){return this._pluralize(a)},_pluralize:function(a){return a+"s"},_serialize:function(a,b){var c=g(b);if(delete c[this.schema.idField],c.links){var d={};for(var e in c.links){var f=c.links[e];d[e]="object"==typeof f?Object.keys(f):f}c.links=d}return c},_deserialize:function(a,b){return b}}),k}),define("orbit_common/jsonapi_source",["orbit/lib/assert","orbit/lib/objects","orbit_common/lib/exceptions","orbit/main","orbit_common/source"],function(a,b,c,d,e){"use strict";var f=a.assert,g=b.clone,h=b.extend,i=c.RecordNotFoundException,j=c.RecordAlreadyExistsException,k=function(){this.init.apply(this,arguments)};return h(k.prototype,e.prototype,{constructor:k,init:function(a,b){f("JSONAPISource requires Orbit.Promise be defined",d.Promise),f("JSONAPISource requires Orbit.ajax be defined",d.ajax),e.prototype.init.apply(this,arguments),b=b||{},this.schema=a,this.remoteIdField=b.remoteIdField||"id",this.namespace=b.namespace,this.headers=b.headers,this._remoteToLocalIdMap={},this._localToRemoteIdMap={}},initRecord:function(a,b){var c=b[this.schema.idField],d=b[this.remoteIdField];d&&!c&&(c=b[this.idField]=this._remoteToLocalId(d)),c||(this.schema.initRecord(a,b),c=b[this.schema.idField]),this._updateRemoteIdMap(a,c,d)},_transform:function(a){var b,c,d=this,e=a.path,f=a.value,g=e[0],h=e[1];if(e.length>2){if(b=this._localToRemoteId(g,h),!b)throw new i(g,h);var k=this._buildURL(g,b);if(e=e.slice(2),"links"===e[0]){var l,m=e[1],n=this._cache.schema.models[g].links[m];"remove"===a.op?e.length>2&&(l=e.pop(),e.push(this._localToRemoteId(n.model,l))):(e.length>2?(l=e.pop(),e.push("-")):l=f,f=this._localToRemoteId(n.model,l))}var o={op:a.op,path:k+"/"+e.join("/")};return f&&(o.value=f),this._ajax(k,"PATCH",{data:o}).then(function(){d._transformCache(a)})}if("add"===a.op){if(h){var p=d.retrieve([g,h]);if(p)throw new j(g,h)}return this._ajax(this._buildURL(g),"POST",{data:this._serialize(g,f)}).then(function(a){c=d._deserialize(g,a),c[d.schema.idField]=h,d._addToCache(g,c)})}if(b=this._localToRemoteId(g,h),!b)throw new i(g,h);return"replace"===a.op?this._ajax(this._buildURL(g,b),"PUT",{data:this._serialize(g,f)}).then(function(a){c=d._deserialize(g,a),c[d.schema.idField]=h,d._addToCache(g,c)}):"remove"===a.op?this._ajax(this._buildURL(g,b),"DELETE").then(function(){d._transformCache(a)}):void 0},_find:function(a,b){if(!b||"number"!=typeof b&&"string"!=typeof b)return b&&"object"==typeof b&&b[this.remoteIdField]?this._findOne(a,b[this.remoteIdField]):this._findQuery(a,b);var c=this._localToRemoteId(a,b);if(!c)throw new i(a,b);return this._findOne(a,c)},_addToCache:function(a,b){this.initRecord(a,b),this._transformCache({op:"add",path:[a,b[this.schema.idField]],value:b})},_findOne:function(a,b){var c=this;return this._ajax(this._buildURL(a,b),"GET").then(function(b){var d=c._deserialize(a,b);return c._addToCache(a,d),c.settleTransforms().then(function(){return d})})},_findQuery:function(a,b){var c=this;return this._ajax(this._buildURL(a),"GET",{data:b}).then(function(b){var d,e=[];return b.forEach(function(b){d=c._deserialize(a,b),c._addToCache(a,d),e.push(d)}),c.settleTransforms().then(function(){return e})})},_localToRemoteId:function(a,b){var c=this._localToRemoteIdMap[a];return c?c[b]:void 0},_remoteToLocalId:function(a,b){var c=this._remoteToLocalIdMap[a];return c?c[b]:void 0},_transformCache:function(a){var b,c;b="add"===a.op?a.path.slice(0,a.path.length-1):a.path,c=this.retrieve(b)?this._cache.transform(a,!0):[],this.didTransform(a,c)},_updateRemoteIdMap:function(a,b,c){if(b&&c){var d;d=this._remoteToLocalIdMap[a],d||(d=this._remoteToLocalIdMap[a]={}),d[c]=b,d=this._localToRemoteIdMap[a],d||(d=this._localToRemoteIdMap[a]={}),d[b]=c}},_ajax:function(a,b,c){var e=this;return new d.Promise(function(f,g){if(c=c||{},c.url=a,c.type=b,c.dataType="json",c.context=e,c.data&&"GET"!==b&&(c.contentType="application/json; charset=utf-8",c.data=JSON.stringify(c.data)),void 0!==e.headers){var h=e.headers;c.beforeSend=function(a){for(var b in h)h.hasOwnProperty(b)&&a.setRequestHeader(b,h[b])}}c.success=function(a){f(a)},c.error=function(a){a&&(a.then=null),g(a)},d.ajax(c)})},_buildURL:function(a,b){var c=this.host,d=this.namespace,e=[];return c&&e.push(c),d&&e.push(d),e.push(this._pathForType(a)),b&&e.push(b),e=e.join("/"),c||(e="/"+e),e},_pathForType:function(a){return this._pluralize(a)},_pluralize:function(a){return a+"s"},_serialize:function(a,b){var c=g(b);if(delete c[this.schema.idField],c.links){var d={};for(var e in c.links){var f=c.links[e];d[e]="object"==typeof f?Object.keys(f):f}c.links=d}return c},_deserialize:function(a,b){return b}}),k}),function(a){var b=a.Orbit.__defineModule__,c=a.Orbit.__requireModule__;b("orbit_common/jsonapi_source",["orbit/lib/assert","orbit/lib/objects","orbit_common/lib/exceptions","orbit/main","orbit_common/source"],function(a,b,c,d,e){"use strict";var f=a.assert,g=b.clone,h=b.extend,i=c.RecordNotFoundException,j=c.RecordAlreadyExistsException,k=function(){this.init.apply(this,arguments)};return h(k.prototype,e.prototype,{constructor:k,init:function(a,b){f("JSONAPISource requires Orbit.Promise be defined",d.Promise),f("JSONAPISource requires Orbit.ajax be defined",d.ajax),e.prototype.init.apply(this,arguments),b=b||{},this.schema=a,this.remoteIdField=b.remoteIdField||"id",this.namespace=b.namespace,this.headers=b.headers,this._remoteToLocalIdMap={},this._localToRemoteIdMap={}},initRecord:function(a,b){var c=b[this.schema.idField],d=b[this.remoteIdField];d&&!c&&(c=b[this.idField]=this._remoteToLocalId(d)),c||(this.schema.initRecord(a,b),c=b[this.schema.idField]),this._updateRemoteIdMap(a,c,d)},_transform:function(a){var b,c,d=this,e=a.path,f=a.value,g=e[0],h=e[1];if(e.length>2){if(b=this._localToRemoteId(g,h),!b)throw new i(g,h);var k=this._buildURL(g,b);if(e=e.slice(2),"links"===e[0]){var l,m=e[1],n=this._cache.schema.models[g].links[m];"remove"===a.op?e.length>2&&(l=e.pop(),e.push(this._localToRemoteId(n.model,l))):(e.length>2?(l=e.pop(),e.push("-")):l=f,f=this._localToRemoteId(n.model,l))}var o={op:a.op,path:k+"/"+e.join("/")};return f&&(o.value=f),this._ajax(k,"PATCH",{data:o}).then(function(){d._transformCache(a)})}if("add"===a.op){if(h){var p=d.retrieve([g,h]);if(p)throw new j(g,h)}return this._ajax(this._buildURL(g),"POST",{data:this._serialize(g,f)}).then(function(a){c=d._deserialize(g,a),c[d.schema.idField]=h,d._addToCache(g,c)})}if(b=this._localToRemoteId(g,h),!b)throw new i(g,h);return"replace"===a.op?this._ajax(this._buildURL(g,b),"PUT",{data:this._serialize(g,f)}).then(function(a){c=d._deserialize(g,a),c[d.schema.idField]=h,d._addToCache(g,c)}):"remove"===a.op?this._ajax(this._buildURL(g,b),"DELETE").then(function(){d._transformCache(a)}):void 0},_find:function(a,b){if(!b||"number"!=typeof b&&"string"!=typeof b)return b&&"object"==typeof b&&b[this.remoteIdField]?this._findOne(a,b[this.remoteIdField]):this._findQuery(a,b);var c=this._localToRemoteId(a,b);if(!c)throw new i(a,b);return this._findOne(a,c)},_addToCache:function(a,b){this.initRecord(a,b),this._transformCache({op:"add",path:[a,b[this.schema.idField]],value:b})},_findOne:function(a,b){var c=this;return this._ajax(this._buildURL(a,b),"GET").then(function(b){var d=c._deserialize(a,b);return c._addToCache(a,d),c.settleTransforms().then(function(){return d})})},_findQuery:function(a,b){var c=this;return this._ajax(this._buildURL(a),"GET",{data:b}).then(function(b){var d,e=[];return b.forEach(function(b){d=c._deserialize(a,b),c._addToCache(a,d),e.push(d)}),c.settleTransforms().then(function(){return e})})},_localToRemoteId:function(a,b){var c=this._localToRemoteIdMap[a];return c?c[b]:void 0},_remoteToLocalId:function(a,b){var c=this._remoteToLocalIdMap[a];return c?c[b]:void 0},_transformCache:function(a){var b,c;b="add"===a.op?a.path.slice(0,a.path.length-1):a.path,c=this.retrieve(b)?this._cache.transform(a,!0):[],this.didTransform(a,c)},_updateRemoteIdMap:function(a,b,c){if(b&&c){var d;d=this._remoteToLocalIdMap[a],d||(d=this._remoteToLocalIdMap[a]={}),d[c]=b,d=this._localToRemoteIdMap[a],d||(d=this._localToRemoteIdMap[a]={}),d[b]=c}},_ajax:function(a,b,c){var e=this;return new d.Promise(function(f,g){if(c=c||{},c.url=a,c.type=b,c.dataType="json",c.context=e,c.data&&"GET"!==b&&(c.contentType="application/json; charset=utf-8",c.data=JSON.stringify(c.data)),void 0!==e.headers){var h=e.headers;c.beforeSend=function(a){for(var b in h)h.hasOwnProperty(b)&&a.setRequestHeader(b,h[b])}}c.success=function(a){f(a)},c.error=function(a){a&&(a.then=null),g(a)},d.ajax(c)})},_buildURL:function(a,b){var c=this.host,d=this.namespace,e=[];return c&&e.push(c),d&&e.push(d),e.push(this._pathForType(a)),b&&e.push(b),e=e.join("/"),c||(e="/"+e),e},_pathForType:function(a){return this._pluralize(a)},_pluralize:function(a){return a+"s"},_serialize:function(a,b){var c=g(b);if(delete c[this.schema.idField],c.links){var d={};for(var e in c.links){var f=c.links[e];d[e]="object"==typeof f?Object.keys(f):f}c.links=d}return c},_deserialize:function(a,b){return b}}),k}),a.OC.JSONAPISource=c("orbit_common/jsonapi_source")}(window);