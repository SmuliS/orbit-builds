define("orbit_common/jsonapi_source",["orbit/lib/assert","orbit/lib/objects","orbit_common/lib/exceptions","orbit/main","orbit_common/source"],function(a,b,c,d,e){"use strict";var f=a.assert,g=b.clone,h=b.extend,i=b.isArray,j=c.RecordNotFoundException,k=c.RecordAlreadyExistsException,l=function(){this.init.apply(this,arguments)};return h(l.prototype,e.prototype,{constructor:l,init:function(a,b){f("JSONAPISource requires Orbit.Promise be defined",d.Promise),f("JSONAPISource requires Orbit.ajax be defined",d.ajax),e.prototype.init.apply(this,arguments),b=b||{},this.namespace=b.namespace,this.headers=b.headers},_transform:function(a){var b,c,d=this,e=a.op,f=a.path,g=a.value,h=f[0],i=f[1];if(f.length>2){if(b=this.schema.localToRemoteId(h,i),!b)throw new j(h,i);var l=this.buildURL(h,b);if(f=f.slice(2),"__rel"===f[0]){f[0]="links";var m,n=f[1],o=this._cache.schema.models[h].links[n];"remove"===e?f.length>2&&(m=f.pop(),f.push(this.schema.localToRemoteId(o.model,m))):(f.length>2?(m=f.pop(),f.push("-")):m=g,g=this.schema.localToRemoteId(o.model,m))}var p={op:e,path:l+"/"+f.join("/")};return g&&(p.value=g),this.ajax(l,"PATCH",{data:p}).then(function(){d._transformCache(a)})}if("add"===e){if(i){var q=d.retrieve([h,i]);if(q)throw new k(h,i)}return this.ajax(this.buildURL(h),"POST",{data:this.serialize(h,g)}).then(function(a){c=d.deserialize(h,a),c[d.schema.idField]=i,d._addToCache(h,c)})}if(b=this.schema.localToRemoteId(h,i),!b)throw new j(h,i);return"replace"===e?this.ajax(this.buildURL(h,b),"PUT",{data:this.serialize(h,g)}).then(function(a){c=d.deserialize(h,a),c[d.schema.idField]=i,d._addToCache(h,c)}):"remove"===e?this.ajax(this.buildURL(h,b),"DELETE").then(function(){d._transformCache(a)}):void 0},_find:function(a,b){var c;if(!b||"number"!=typeof b&&"string"!=typeof b){if(b&&i(b)){for(var d,e=[],f=[],g=0,h=b.length;h>g;g++)d=b[g],c="object"==typeof d&&d[this.schema.remoteIdField]?d[this.schema.remoteIdField]:this.schema.localToRemoteId(a,d),c?e.push(c):f.push(d);if(f.length>0)throw new j(a,f);return this._findMany(a,e)}return b&&"object"==typeof b&&b[this.schema.remoteIdField]?this._findOne(a,b[this.schema.remoteIdField]):this._findQuery(a,b)}if(c=this.schema.localToRemoteId(a,b),!c)throw new j(a,b);return this._findOne(a,c)},_addToCache:function(a,b){return b=this.normalize(a,b),this._transformCache({op:"add",path:[a,this.getId(b)],value:b}),b},_findOne:function(a,b){var c=this;return this.ajax(this.buildURL(a,b),"GET").then(function(b){var d=c.deserialize(a,b),e=c._addToCache(a,d);return c.settleTransforms().then(function(){return e})})},_findMany:function(a,b){var c=this;return this.ajax(this.buildURL(a,b),"GET").then(function(b){var d,e,f=[];return b.forEach(function(b){d=c.deserialize(a,b),e=c._addToCache(a,d),f.push(e)}),c.settleTransforms().then(function(){return f})})},_findQuery:function(a,b){var c=this;return this.ajax(this.buildURL(a),"GET",{data:b}).then(function(b){var d,e,f=[];return b.forEach(function(b){d=c.deserialize(a,b),e=c._addToCache(a,d),f.push(e)}),c.settleTransforms().then(function(){return f})})},_transformCache:function(a){var b;b="add"===a.op?a.path.slice(0,a.path.length-1):a.path,this.retrieve(b)?this._cache.transform(a):this.didTransform(a,[])},ajax:function(a,b,c){var e=this;return new d.Promise(function(f,g){if(c=c||{},c.url=a,c.type=b,c.dataType="json",c.context=e,c.data&&"GET"!==b&&(c.contentType="application/json; charset=utf-8",c.data=JSON.stringify(c.data)),void 0!==e.headers){var h=e.headers;c.beforeSend=function(a){for(var b in h)h.hasOwnProperty(b)&&a.setRequestHeader(b,h[b])}}c.success=function(a){f(a)},c.error=function(a){a&&(a.then=null),g(a)},d.ajax(c)})},buildURL:function(a,b){var c=this.host,d=this.namespace,e=[];return c&&e.push(c),d&&e.push(d),e.push(this.pathForType(a)),b&&e.push(i(b)?b.join(","):b),e=e.join("/"),c||(e="/"+e),e},pathForType:function(a){return this.schema.pluralize(a)},serialize:function(a,b){var c=g(b);if(delete c.__normalized,delete c.__rev,this.schema.idField!==this.schema.remoteIdField&&delete c[this.schema.idField],c.__rel){var d=Object.keys(c.__rel);if(d.length>0){var e={};d.forEach(function(a){var b=c.__rel[a];e[a]="object"==typeof b?Object.keys(b):b}),c.links=e}delete c.__rel}return c},deserialize:function(a,b){return b}}),l});